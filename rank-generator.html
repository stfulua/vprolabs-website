<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vRankGenerator - vProLabs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0a;
            --surface: #111;
            --surface-hover: #1a1a1a;
            --border: #222;
            --text: #e0e0e0;
            --text-muted: #666;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .lang-select {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .lang-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .lang-btn:hover, .lang-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 80px 20px 40px;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .color-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        input[type="color"] {
            width: 60px;
            height: 44px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: none;
        }

        .gradient-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 12px;
        }

        .gradient-toggle:hover {
            background: var(--surface-hover);
        }

        .gradient-toggle span {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .gradient-panel {
            display: none;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .gradient-panel.open {
            display: grid;
        }

        @media (max-width: 600px) {
            .gradient-panel {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .preset-btn {
            height: 40px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .preset-btn:hover {
            transform: scale(1.05);
        }

        .preset-btn.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--surface-hover);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .preview-box {
            background: var(--bg);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        canvas {
            max-width: 100%;
            height: auto;
            image-rendering: pixelated;
            display: block;
            margin: 0 auto;
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 12px;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--surface-hover);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .ranks-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .rank-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .rank-item img {
            width: 80px;
            height: 40px;
            object-fit: contain;
            image-rendering: pixelated;
            background: #0a0a0a;
        }

        .rank-info {
            flex: 1;
        }

        .rank-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .rank-char {
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--accent);
        }

        .rank-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-text {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-close {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: block;
            padding: 16px;
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .file-label:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 600px) {
            .actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="lang-select">
        <button class="lang-btn active" onclick="setLang('pl')">ðŸ‡µðŸ‡± PL</button>
        <button class="lang-btn" onclick="setLang('en')">ðŸ‡ºðŸ‡¸ EN</button>
    </div>

    <div class="container">
        <header>
            <h1>vRankGenerator</h1>
            <p class="subtitle" data-key="subtitle">Generator rang Minecraft z poprawnymi rozmiarami</p>
        </header>

        <div class="card">
            <div class="card-title" data-key="config">Konfiguracja</div>
            
            <div class="form-group">
                <label data-key="rankName">Nazwa rangi</label>
                <input type="text" id="rankName" placeholder="ADMIN" oninput="updatePreview()">
            </div>

            <div class="form-group">
                <label data-key="font">Czcionka</label>
                <select id="fontStyle" onchange="updatePreview()">
                    <option value="VT323">VT323</option>
                    <option value="Press Start 2P">Press Start 2P</option>
                    <option value="Russo One">Russo One</option>
                    <option value="Black Ops One">Black Ops One</option>
                    <option value="Bungee">Bungee</option>
                    <option value="Quantico">Quantico</option>
                    <option value="Montserrat">Montserrat ExtraBold</option>
                </select>
            </div>

            <div class="form-group">
                <label data-key="shape">KsztaÅ‚t</label>
                <select id="shapeStyle" onchange="updatePreview()">
                    <option value="chamfer" data-key="chamfer">ÅšciÄ™te rogi</option>
                    <option value="square" data-key="square">ProstokÄ…t</option>
                    <option value="rounded" data-key="rounded">ZaokrÄ…glony</option>
                </select>
            </div>

            <div class="gradient-toggle" onclick="toggleGradients()">
                <span data-key="gradients">Szablony gradientÃ³w</span>
                <span id="arrow">â–¼</span>
            </div>
            
            <div class="gradient-panel" id="gradientPanel"></div>

            <div class="form-group">
                <label data-key="colors">Kolory</label>
                <div class="color-row">
                    <input type="color" id="color1" value="#3b82f6" oninput="updatePreview()">
                    <input type="color" id="color2" value="#8b5cf6" oninput="updatePreview()">
                </div>
            </div>

            <div class="form-group">
                <label data-key="textColor">Kolor tekstu</label>
                <input type="color" id="textColor" value="#ffffff" oninput="updatePreview()" style="width: 60px; height: 44px;">
            </div>

            <div class="checkbox-wrapper">
                <input type="checkbox" id="power2Check" checked onchange="updatePreview()">
                <label for="power2Check">
                    <span data-key="power2">WymuÅ› rozmiar potÄ™gi 2 (dla Minecraft 1.21+)</span>
                    <button class="help-btn" onclick="showHelp(event)">?</button>
                </label>
            </div>

            <div class="preview-box">
                <canvas id="previewCanvas"></canvas>
            </div>

            <button class="btn" onclick="addRank()" data-key="addRank">Dodaj rangÄ™</button>
            
            <input type="file" id="mgfLoad" class="file-input" accept=".mgf,.json" onchange="loadMGF(event)">
            <label for="mgfLoad" class="file-label" data-key="loadMGF">Wczytaj .mgf</label>
        </div>

        <div class="card">
            <div class="card-title" data-key="list">Lista rang</div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="statCount">0</div>
                    <div class="stat-label" data-key="ranks">Rangi</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statSlots">64</div>
                    <div class="stat-label" data-key="slots">Sloty</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statSize">-</div>
                    <div class="stat-label">Size</div>
                </div>
            </div>

            <div class="ranks-list" id="ranksList">
                <div class="empty-state" data-key="empty">Brak rang. Dodaj pierwszÄ…!</div>
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="saveMGF()" data-key="saveMGF">Zapisz .mgf</button>
                <button class="btn" onclick="generatePack()" data-key="generatePack">Generuj TexturePack</button>
            </div>
        </div>
    </div>

    <div class="modal" id="helpModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" data-key="helpTitle">Rozmiar potÄ™gi 2</div>
            <div class="modal-text" data-key="helpText">
                Minecraft 1.21+ wymaga, aby tekstury miaÅ‚y rozmiar bÄ™dÄ…cy potÄ™gÄ… liczby 2 
                (np. 64x32, 128x32, 256x32). Ta opcja automatycznie dopasowuje szerokoÅ›Ä‡ 
                rangi do najbliÅ¼szej poprawnej wartoÅ›ci.
            </div>
            <button class="modal-close" onclick="closeModal()" data-key="close">Zamknij</button>
        </div>
    </div>

    <footer>
        vProLabs &copy; 2024
    </footer>

    <script>
        const TRANSLATIONS = {
            pl: {
                subtitle: "Generator rang Minecraft z poprawnymi rozmiarami",
                config: "Konfiguracja",
                rankName: "Nazwa rangi",
                font: "Czcionka",
                shape: "KsztaÅ‚t",
                chamfer: "ÅšciÄ™te rogi",
                square: "ProstokÄ…t",
                rounded: "ZaokrÄ…glony",
                gradients: "Szablony gradientÃ³w",
                colors: "Kolory",
                textColor: "Kolor tekstu",
                power2: "WymuÅ› rozmiar potÄ™gi 2 (dla Minecraft 1.21+)",
                addRank: "Dodaj rangÄ™",
                loadMGF: "Wczytaj .mgf",
                list: "Lista rang",
                ranks: "Rangi",
                slots: "Sloty",
                empty: "Brak rang. Dodaj pierwszÄ…!",
                saveMGF: "Zapisz .mgf",
                generatePack: "Generuj TexturePack",
                helpTitle: "Rozmiar potÄ™gi 2",
                helpText: "Minecraft 1.21+ wymaga, aby tekstury miaÅ‚y rozmiar bÄ™dÄ…cy potÄ™gÄ… liczby 2 (np. 64x32, 128x32, 256x32). Ta opcja automatycznie dopasowuje szerokoÅ›Ä‡ rangi do najbliÅ¼szej poprawnej wartoÅ›ci.",
                close: "Zamknij"
            },
            en: {
                subtitle: "Minecraft rank generator with correct sizes",
                config: "Configuration",
                rankName: "Rank name",
                font: "Font",
                shape: "Shape",
                chamfer: "Chamfered",
                square: "Square",
                rounded: "Rounded",
                gradients: "Gradient templates",
                colors: "Colors",
                textColor: "Text color",
                power2: "Enforce power of 2 size (for Minecraft 1.21+)",
                addRank: "Add rank",
                loadMGF: "Load .mgf",
                list: "Rank list",
                ranks: "Ranks",
                slots: "Slots",
                empty: "No ranks. Add first one!",
                saveMGF: "Save .mgf",
                generatePack: "Generate TexturePack",
                helpTitle: "Power of 2 size",
                helpText: "Minecraft 1.21+ requires textures to have power of 2 dimensions (e.g. 64x32, 128x32, 256x32). This option automatically adjusts rank width to the nearest valid value.",
                close: "Close"
            }
        };

        const GRADIENTS = [
            {name: "Blue", c1: "#3b82f6", c2: "#8b5cf6"},
            {name: "Fire", c1: "#ef4444", c2: "#f97316"},
            {name: "Forest", c1: "#22c55e", c2: "#16a34a"},
            {name: "Gold", c1: "#eab308", c2: "#ca8a04"},
            {name: "Pink", c1: "#ec4899", c2: "#d946ef"},
            {name: "Cyan", c1: "#06b6d4", c2: "#3b82f6"},
            {name: "Purple", c1: "#8b5cf6", c2: "#a855f7"},
            {name: "Red", c1: "#dc2626", c2: "#991b1b"},
            {name: "Orange", c1: "#f97316", c2: "#ea580c"},
            {name: "Teal", c1: "#14b8a6", c2: "#0d9488"},
            {name: "Indigo", c1: "#6366f1", c2: "#4f46e5"},
            {name: "Rose", c1: "#f43f5e", c2: "#e11d48"},
            {name: "Amber", c1: "#f59e0b", c2: "#d97706"},
            {name: "Emerald", c1: "#10b981", c2: "#059669"},
            {name: "Sky", c1: "#0ea5e9", c2: "#0284c7"}
        ];

        const UNICODE_CHARS = Array.from({length: 64}, (_, i) => String.fromCharCode(0xE800 + i));
        
        let ranks = [];
        let currentLang = 'pl';
        let gradientsOpen = false;

        Promise.all([
            document.fonts.load('24px "VT323"'),
            document.fonts.load('24px "Press Start 2P"'),
            document.fonts.load('24px "Russo One"'),
            document.fonts.load('24px "Black Ops One"'),
            document.fonts.load('24px "Bungee"'),
            document.fonts.load('24px "Quantico"'),
            document.fonts.load('24px "Montserrat"')
        ]).then(() => {
            initGradients();
            updatePreview();
        });

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(lang.toUpperCase()));
            });
            
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (TRANSLATIONS[lang][key]) {
                    el.textContent = TRANSLATIONS[lang][key];
                }
            });
        }

        function initGradients() {
            const panel = document.getElementById('gradientPanel');
            GRADIENTS.forEach((g, i) => {
                const btn = document.createElement('div');
                btn.className = 'preset-btn';
                btn.style.background = `linear-gradient(135deg, ${g.c1}, ${g.c2})`;
                btn.onclick = () => selectGradient(i, btn);
                if (i === 0) btn.classList.add('active');
                panel.appendChild(btn);
            });
            selectGradient(0, panel.children[0]);
        }

        function toggleGradients() {
            gradientsOpen = !gradientsOpen;
            document.getElementById('gradientPanel').classList.toggle('open', gradientsOpen);
            document.getElementById('arrow').textContent = gradientsOpen ? 'â–²' : 'â–¼';
        }

        function selectGradient(index, btn) {
            const g = GRADIENTS[index];
            document.getElementById('color1').value = g.c1;
            document.getElementById('color2').value = g.c2;
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            updatePreview();
        }

        function getPower2Width(textWidth) {
            const padding = 24;
            const width = textWidth + padding * 2;
            const sizes = [64, 128, 256, 512];
            for (let s of sizes) if (width <= s) return s;
            return 512;
        }

        function drawCanvas(canvas, text, opts) {
            const ctx = canvas.getContext('2d');
            const font = opts.font || 'VT323';
            let size = font === 'Press Start 2P' ? 14 : font === 'Montserrat' ? 20 : 22;
            
            ctx.font = `bold ${size}px "${font}"`;
            const metrics = ctx.measureText(text);
            
            let w, h = 32;
            if (opts.power2) {
                w = getPower2Width(metrics.width);
            } else {
                w = metrics.width + 48;
            }
            
            canvas.width = w;
            canvas.height = h;
            
            ctx.font = `bold ${size}px "${font}"`;
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';
            
            const grad = ctx.createLinearGradient(0, 0, w, 0);
            grad.addColorStop(0, opts.c1);
            grad.addColorStop(1, opts.c2);
            ctx.fillStyle = grad;
            
            if (opts.shape === 'chamfer') {
                const c = 6;
                ctx.beginPath();
                ctx.moveTo(c, 0);
                ctx.lineTo(w-c, 0);
                ctx.lineTo(w, c);
                ctx.lineTo(w, h-c);
                ctx.lineTo(w-c, h);
                ctx.lineTo(c, h);
                ctx.lineTo(0, h-c);
                ctx.lineTo(0, c);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();
            } else if (opts.shape === 'rounded') {
                ctx.beginPath();
                ctx.roundRect(0, 0, w, h, 8);
                ctx.fill();
            } else {
                ctx.fillRect(0, 0, w, h);
            }
            
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillText(text, w/2 + 1, h/2 + 1);
            ctx.fillStyle = opts.textColor;
            ctx.fillText(text, w/2, h/2);
            
            return {w, h};
        }

        function updatePreview() {
            const c = document.getElementById('previewCanvas');
            const size = drawCanvas(c, (document.getElementById('rankName').value || 'PREVIEW').toUpperCase(), {
                font: document.getElementById('fontStyle').value,
                shape: document.getElementById('shapeStyle').value,
                c1: document.getElementById('color1').value,
                c2: document.getElementById('color2').value,
                textColor: document.getElementById('textColor').value,
                power2: document.getElementById('power2Check').checked
            });
            document.getElementById('statSize').textContent = `${size.w}x${size.h}`;
        }

        function addRank() {
            const name = document.getElementById('rankName').value.trim();
            if (!name) return alert(currentLang === 'pl' ? 'Wpisz nazwÄ™!' : 'Enter name!');
            if (ranks.length >= 64) return alert(currentLang === 'pl' ? 'Limit 64 rang!' : '64 ranks limit!');
            
            const canvas = document.createElement('canvas');
            const size = drawCanvas(canvas, name.toUpperCase(), {
                font: document.getElementById('fontStyle').value,
                shape: document.getElementById('shapeStyle').value,
                c1: document.getElementById('color1').value,
                c2: document.getElementById('color2').value,
                textColor: document.getElementById('textColor').value,
                power2: true
            });
            
            ranks.push({
                id: Date.now(),
                name: name.toUpperCase(),
                display: name,
                char: UNICODE_CHARS[ranks.length],
                dataUrl: canvas.toDataURL('image/png'),
                w: size.w,
                h: size.h,
                settings: {
                    font: document.getElementById('fontStyle').value,
                    shape: document.getElementById('shapeStyle').value,
                    c1: document.getElementById('color1').value,
                    c2: document.getElementById('color2').value,
                    textColor: document.getElementById('textColor').value
                }
            });
            
            document.getElementById('rankName').value = '';
            render();
            updatePreview();
        }

        function render() {
            const list = document.getElementById('ranksList');
            document.getElementById('statCount').textContent = ranks.length;
            document.getElementById('statSlots').textContent = 64 - ranks.length;
            
            if (ranks.length === 0) {
                list.innerHTML = `<div class="empty-state">${TRANSLATIONS[currentLang].empty}</div>`;
                return;
            }
            
            list.innerHTML = ranks.map((r, i) => `
                <div class="rank-item">
                    <img src="${r.dataUrl}">
                    <div class="rank-info">
                        <div class="rank-name">${r.display}</div>
                        <div class="rank-char">${r.char}</div>
                        <div class="rank-meta">${r.settings.font} â€¢ ${r.w}x${r.h}</div>
                    </div>
                    <button class="btn btn-danger" style="width: auto; padding: 8px 16px;" onclick="deleteRank(${r.id})">Ã—</button>
                </div>
            `).join('');
        }

        function deleteRank(id) {
            ranks = ranks.filter(r => r.id !== id);
            ranks.forEach((r, i) => r.char = UNICODE_CHARS[i]);
            render();
        }

        function saveMGF() {
            if (!ranks.length) return;
            const data = {
                version: "2.0",
                tool: "vRankGenerator",
                date: new Date().toISOString(),
                ranks: ranks.map(r => ({name: r.display, settings: r.settings}))
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ranks-${ranks.length}.mgf`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadMGF(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    ranks = [];
                    data.ranks.forEach(r => {
                        document.getElementById('fontStyle').value = r.settings.font;
                        document.getElementById('shapeStyle').value = r.settings.shape;
                        document.getElementById('color1').value = r.settings.c1;
                        document.getElementById('color2').value = r.settings.c2;
                        document.getElementById('textColor').value = r.settings.textColor;
                        const canvas = document.createElement('canvas');
                        const size = drawCanvas(canvas, r.name.toUpperCase(), {...r.settings, power2: true});
                        ranks.push({
                            id: Date.now() + Math.random(),
                            name: r.name.toUpperCase(),
                            display: r.name,
                            char: UNICODE_CHARS[ranks.length],
                            dataUrl: canvas.toDataURL('image/png'),
                            w: size.w,
                            h: size.h,
                            settings: r.settings
                        });
                    });
                    render();
                    alert(`Loaded ${ranks.length} ranks!`);
                } catch(err) {
                    alert('Error loading file!');
                }
            };
            reader.readAsText(file);
        }

        async function generatePack() {
            if (!ranks.length) return;
            
            const zip = new JSZip();
            const assets = zip.folder("assets").folder("minecraft");
            const textures = assets.folder("textures").folder("ranks");
            const font = assets.folder("font");
            
            // Only used chars - NO NULL ENTRIES
            const providers = ranks.map(r => ({
                type: "bitmap",
                file: `minecraft:ranks/${r.display.toLowerCase().replace(/[^a-z0-9]/g, '_')}.png`,
                ascent: 7,
                height: 7,
                chars: [r.char]
            }));
            
            font.file("default.json", JSON.stringify({providers}, null, 4));
            
            // chars.txt
            const charsTxt = ranks.map(r => `${r.display} - "${r.char}"`).join('\n');
            zip.file("chars.txt", charsTxt);
            
            // Images
            ranks.forEach(r => {
                const base64 = r.dataUrl.split(',')[1];
                textures.file(`${r.display.toLowerCase().replace(/[^a-z0-9]/g, '_')}.png`, base64, {base64: true});
            });
            
            // pack.mcmeta
            zip.file("pack.mcmeta", JSON.stringify({
                pack: {pack_format: 46, description: "    Â§bÂ§lvRankGeneratorÂ§fÂ§l by vProLabs"}
            }, null, 4));
            
            const blob = await zip.generateAsync({type: "blob"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vRankGenerator-Pack-${ranks.length}.zip`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showHelp(e) {
            e.preventDefault();
            document.getElementById('helpModal').classList.add('open');
        }

        function closeModal(e) {
            if (!e || e.target.id === 'helpModal' || e.target.classList.contains('modal-close')) {
                document.getElementById('helpModal').classList.remove('open');
            }
        }
    </script>
</body>
</html>
